## 目标与范围

* 完成后端用户注册、登录、登出、状态检查、令牌刷新、令牌校验的闭环，并统一为稳定的响应结构。比如把核心响应包裹在data对象里, 并在后期开发时遵守这一约定.

* 前端提供注册/登录界面与状态管理，路由守卫与自动恢复会话。

* 消除类型与语法告警，保证构建与运行无错误。

## 后端改动（Flask + SQLAlchemy + JWT）

* 接入配置与数据库

  * 在 `backend/app.py`：加载 `config.Config`，初始化 `db.init_app(app)` 与 `Migrate(app, db)`；保留已启用的 `CORS`。

  * 统一注册蓝图，补注册 `post_bp`（如需）。

* 切换认证到 JWT

  * 在 `backend/app.py`：初始化 `JWTManager(app)`，读取 `JWT_SECRET_KEY`；默认访问令牌 15–30 分钟有效期，可选启用刷新令牌。

  * 在 `backend/app/api/auth.py`：

    * `POST /api/auth/register`：写入 `User` ORM，密码使用 `werkzeug.security.generate_password_hash`；返回 `success(code=0)`。

    * `POST /api/auth/login`：使用 `check_password_hash` 校验；`create_access_token(identity=user.id)` 返回 `access_token`（保留统一响应结构）；可选同时返回 `refresh_token`。

    * `POST /api/auth/logout`：前端侧清除令牌即可；后端返回 `success`（如需黑名单可后续接入）。

    * `GET /api/auth/status`：`@jwt_required()`，返回当前用户公开信息与令牌剩余有效期。

    * `POST /api/auth/refresh`：如启用刷新，使用 `@jwt_required(refresh=True)` 生成新 `access_token`。

    * `POST /api/auth/validate`：`@jwt_required()`，返回令牌有效并回传身份。

  * 在受保护接口（`backend/app/api/user.py` 等）统一使用 `@jwt_required()`，去除重复的令牌解析逻辑。

* 服务层与 ORM 接入

  * 在 `backend/app/service/auth_service.py` 与 `user_service.py`：改为使用 `User` ORM 查询与写入；删除或隔离内存 `_mock_users/_mock_sessions`；保留方法名以减少路由改动。

  * 响应统一通过 `backend/app/utils/responses.py`（`success`/`fail`），捕获常见异常返回明确错误码与信息。

* 安全与错误处理

  * 密码使用 `werkzeug.security`；禁止明文与不安全哈希。

  * 生产环境 Cookie 设定 `secure=True`、`SameSite=Strict`（开发保持当前行为）。

  * 管理员接口在 `user.py` 增加权限校验（基于 `User.role` 或 `is_admin` 字段）。

## 前端改动（Vue 3 + Vite + NaiveUI + TS）

* API 与请求

  * 在 `frontend/src/utils/request.ts`：保留现有 `Authorization: Bearer {token}` 注入；401 时尝试刷新令牌（如启用），失败则跳登录。

  * 在 `frontend/src/api/user.ts`：

    * 统一接口返回类型定义（`ApiResponse<T>`），对 `login/register/status/validate/refresh` 进行类型约束。

* 状态管理与 UI

  * 在 `frontend/src/store/auth.ts`（如不存在则新增）：存储 `token`、`user`、`expiresAt`；提供 `login/logout/restore` 动作。

  * 登录/注册页面：使用 NaiveUI `n-form` + `n-input` + `n-button`；表单校验（邮箱格式、密码最小长度、重复密码一致）。

  * 在 `frontend/src/router/index.ts`：路由守卫读取 `auth` 状态；无令牌访问受限页跳转登录；应用启动时调用 `status` 尝试恢复会话。

* 类型与告警治理

  * 为各 API 响应与 DTO 定义 TS 接口；移除未使用变量；确保 `strict: true` 下通过编译。

  * 保持缩进与代码风格（除 Python 外缩进为 2 空格）。

## 校验与测试

* 后端

  * 编写最小集成测试：注册 → 登录 → `status` → `validate` → （可选）`refresh` → 登出；覆盖常见错误路径（重复注册、错误密码、过期令牌）。

  * 运行本地 SQLite（`instance/app.db`），确保迁移与模型一致。

* 前端

  * 端到端验证：通过页面完成注册与登录；刷新页面后能通过 `status` 恢复；访问受限页正常拦截。

  * 运行构建与 ESLint，确认无告警/错误；修复 TS 类型问题。

## 迁移与兼容性

* 保持接口路径与响应结构不变（`success/fail` + `code/message/data`），只将令牌生成与校验改为 JWT。

* 前端无需重启后端即可调试；按项目规则继续使用 NaiveUI 与 Bootstrap。

## 交付物

* 后端：配置与 DB 初始化、JWT 接入、受保护路由、服务层重构、统一响应与错误处理。

* 前端：认证页面与状态管理、API 类型约束、路由守卫与拦截器完善。

* 测试与验证：后端集成测试、前端构建与 ESLint 全通过，实际流程跑通。

